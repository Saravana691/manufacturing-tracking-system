<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Tracking System v3.1 - Google Drive Backup</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --color-primary: #208791;
            --color-primary-hover: #197683;
            --color-primary-active: #166b75;
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-success: #208791;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
            --color-info: #626c71;
            --color-bg: #fcfcf9;
            --color-surface: #fffff5;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --spacing-4: 4px;
            --spacing-8: 8px;
            --spacing-12: 12px;
            --spacing-16: 16px;
            --spacing-20: 20px;
            --spacing-24: 24px;
            --radius-base: 8px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #208791 0%, #197683 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: var(--radius-base);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 24px;
            color: var(--color-text);
        }

        .login-box p {
            text-align: center;
            color: var(--color-text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .google-signin-btn {
            width: 100%;
            margin: 15px 0;
        }

        .google-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }

        .google-divider::before,
        .google-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }

        .google-divider span {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text);
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 14px;
            color: var(--color-text);
            background-color: var(--color-surface);
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 135, 145, 0.1);
        }

        .login-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .login-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .login-btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .login-btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .login-btn-secondary:hover {
            background-color: rgba(94, 82, 64, 0.2);
        }

        .login-error {
            color: var(--color-error);
            background: rgba(192, 21, 47, 0.1);
            padding: 12px;
            border-radius: var(--radius-base);
            margin-bottom: 15px;
            font-size: 13px;
            border-left: 4px solid var(--color-error);
            display: none;
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            background: linear-gradient(135deg, #208791 0%, #197683 100%);
            color: white;
            padding: var(--spacing-16) var(--spacing-20);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
        }

        .user-info button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .user-info button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--spacing-20);
            flex: 1;
            overflow-y: auto;
        }

        .alert-banner {
            background: rgba(192, 21, 47, 0.1);
            border: 2px solid var(--color-error);
            color: var(--color-error);
            padding: var(--spacing-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--spacing-20);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .alert-banner .alert-dismiss {
            background: rgba(192, 21, 47, 0.2);
            border: none;
            color: var(--color-error);
            padding: 6px 12px;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .nav-tabs {
            display: flex;
            gap: var(--spacing-8);
            margin-bottom: var(--spacing-20);
            border-bottom: 2px solid var(--color-border);
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: var(--spacing-12) var(--spacing-16);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-bottom: -2px;
        }

        .nav-tab:hover {
            color: var(--color-primary);
        }

        .nav-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--spacing-16);
            margin-bottom: var(--spacing-16);
            box-shadow: var(--shadow-sm);
        }

        .card h2 {
            margin: 0 0 var(--spacing-16) 0;
            font-size: 18px;
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: var(--spacing-8);
        }

        .grid {
            display: grid;
            gap: var(--spacing-16);
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin-bottom: var(--spacing-16);
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(32, 135, 145, 0.1) 0%, rgba(32, 135, 145, 0.05) 100%);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--spacing-16);
            text-align: center;
        }

        .stat-box h3 {
            margin: 0;
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-box .value {
            margin: var(--spacing-12) 0 0 0;
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-box .value.success { color: var(--color-success); }
        .stat-box .value.warning { color: var(--color-warning); }
        .stat-box .value.error { color: var(--color-error); }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            overflow: hidden;
            font-size: 13px;
        }

        thead {
            background: rgba(32, 135, 145, 0.1);
        }

        th {
            padding: var(--spacing-12);
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-text);
            border-right: 1px solid var(--color-border);
        }

        th:last-child {
            border-right: none;
        }

        td {
            padding: var(--spacing-12);
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        td:last-child {
            border-right: none;
        }

        tbody tr:hover {
            background-color: rgba(32, 135, 145, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background-color: rgba(32, 135, 145, 0.15);
            color: var(--color-success);
            border: 1px solid rgba(32, 135, 145, 0.3);
        }

        .badge-warning {
            background-color: rgba(168, 75, 47, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(168, 75, 47, 0.3);
        }

        .badge-error {
            background-color: rgba(192, 21, 47, 0.15);
            color: var(--color-error);
            border: 1px solid rgba(192, 21, 47, 0.3);
        }

        .btn {
            padding: var(--spacing-8) var(--spacing-16);
            border: none;
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-8);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: rgba(94, 82, 64, 0.2);
        }

        .btn-small {
            padding: var(--spacing-4) var(--spacing-12);
            font-size: 12px;
        }

        .form-group {
            margin-bottom: var(--spacing-16);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-8);
            font-weight: 500;
            font-size: 13px;
            color: var(--color-text);
        }

        input, select, textarea {
            width: 100%;
            padding: var(--spacing-8) var(--spacing-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 13px;
            font-family: inherit;
            color: var(--color-text);
            background-color: var(--color-surface);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 135, 145, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-base);
            padding: var(--spacing-24);
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-16);
            padding-bottom: var(--spacing-16);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .action-bar {
            display: flex;
            gap: var(--spacing-12);
            margin-bottom: var(--spacing-20);
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            padding-left: var(--spacing-36);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-12);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-bottom: var(--spacing-16);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .stock-level {
            font-weight: 600;
            padding: var(--spacing-8) var(--spacing-12);
            border-radius: var(--radius-base);
        }

        .stock-level.critical {
            background: rgba(192, 21, 47, 0.15);
            color: var(--color-error);
        }

        .stock-level.warning {
            background: rgba(168, 75, 47, 0.15);
            color: var(--color-warning);
        }

        .stock-level.healthy {
            background: rgba(32, 135, 145, 0.15);
            color: var(--color-success);
        }

        .inline-edit {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }

        .inline-edit input {
            width: 60px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .inline-edit button {
            padding: 4px 8px;
            font-size: 11px;
        }

        .flow-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .flow-step {
            padding: 4px 12px;
            background: rgba(32, 135, 145, 0.1);
            border-radius: 4px;
            font-weight: 500;
        }

        .flow-arrow {
            color: var(--color-primary);
            font-weight: bold;
        }

        .bucket-metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: var(--spacing-20);
            margin-bottom: var(--spacing-20);
        }

        .bucket-card {
            background: linear-gradient(135deg, rgba(32, 135, 145, 0.05) 0%, rgba(32, 135, 145, 0.02) 100%);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--spacing-20);
            box-shadow: var(--shadow-sm);
        }

        .bucket-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: var(--spacing-16);
            padding-bottom: var(--spacing-12);
            border-bottom: 2px solid var(--color-primary);
        }

        .bucket-metrics {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-16);
        }

        .metric-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-12);
        }

        .metric-row.full-row {
            grid-template-columns: 1fr;
        }

        .metric-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--spacing-12);
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-8);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .metric-value.success {
            color: var(--color-success);
        }

        .metric-value.error {
            color: var(--color-error);
        }

        .metric-value.warning {
            color: var(--color-warning);
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .table-wrapper {
                font-size: 12px;
            }
            th, td {
                padding: 8px;
            }
            .bucket-metrics-container {
                grid-template-columns: 1fr;
            }
            .metric-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>üè≠ Manufacturing System v3.0</h1>
            <p id="loginModeText">Sign In</p>
            <div id="loginError" class="login-error"></div>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div class="form-group" id="confirmPasswordGroup" style="display: none;">
                    <label>Confirm Password</label>
                    <input type="password" id="loginConfirmPassword">
                </div>
                <div class="login-buttons">
                    <button type="button" class="login-btn login-btn-primary" onclick="handleLogin()">Sign In</button>
                    <button type="button" class="login-btn login-btn-secondary" onclick="toggleLoginMode()">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="appContainer" class="app-container">
        <div class="app-header">
            <h1>üè≠ Manufacturing Tracking System v3.0 - Complete</h1>
            <div class="user-info">
                <span>üë§ <span id="currentUser">User</span></span>
                <button onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="container">
            <!-- Stock Alert Banner -->
            <div id="stockAlert" class="alert-banner" style="display: none;">
                <div>‚ö†Ô∏è <strong>CRITICAL: Items Below Minimum Stock Level (50 units)</strong><br><span id="alertMessage"></span></div>
                <button class="alert-dismiss" onclick="dismissStockAlert()">‚úï Dismiss</button>
            </div>

            <!-- Top Action Bar -->
            <div class="action-bar">
                <button class="btn btn-primary" onclick="exportAllData()">üì• Export All Data</button>
                <button class="btn btn-secondary" onclick="importData()">üì§ Import Data</button>
                <button class="btn btn-secondary" onclick="backupDataNow()">üíæ Backup Local</button>
                <button class="btn btn-secondary" onclick="restoreDataNow()">üíæ Restore Local</button>
                <button class="btn btn-secondary" onclick="backupToGoogleDrive()" id="gdrive-backup-btn">‚òÅÔ∏è Backup to Google Drive</button>
                <button class="btn btn-secondary" onclick="restoreFromGoogleDrive()" id="gdrive-restore-btn">‚òÅÔ∏è Restore from Google Drive</button>
                <button class="btn btn-secondary" onclick="clearAllData()">üîÑ Reset All Data</button>
            </div>

            <!-- Google Drive Status -->
            <div id="gdriveStatus" style="display: none; background: rgba(32, 135, 145, 0.1); border: 1px solid var(--color-primary); padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                <strong>‚òÅÔ∏è Google Drive Status:</strong>
                <div id="gdriveStatusText" style="margin-top: 8px; font-size: 13px;"></div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab(event, 'dashboard')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchTab(event, 'material-master')">üì¶ Item Master</button>
                <button class="nav-tab" onclick="switchTab(event, 'vendor-master')">üè¢ Vendor Master</button>
                <button class="nav-tab" onclick="switchTab(event, 'bom')">üìã BOM</button>
                <button class="nav-tab" onclick="switchTab(event, 'foundry-order')">üî© Foundry Orders</button>
                <button class="nav-tab" onclick="switchTab(event, 'job-work')">‚öôÔ∏è Job Work Orders</button>
                <button class="nav-tab" onclick="switchTab(event, 'job-card')">üìë Job Cards</button>
                <button class="nav-tab" onclick="switchTab(event, 'assembly')">üîß Assembly</button>
                <button class="nav-tab" onclick="switchTab(event, 'backup-restore')">‚òÅÔ∏è Backup</button>
                <button class="nav-tab" onclick="switchTab(event, 'user-management')">üë• Users</button>
            </div>

            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="section active">
                <div class="card">
                    <h2>üìä Manufacturing Overview - Key Metrics</h2>
                    <div class="grid">
                        <div class="stat-box">
                            <h3>Total Foundry Orders</h3>
                            <div class="value" id="total-fo-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Foundry Completed</h3>
                            <div class="value success" id="completed-fo-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Foundry Pending</h3>
                            <div class="value warning" id="pending-fo-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Total Job Work Orders</h3>
                            <div class="value" id="total-jw-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Job Work Completed</h3>
                            <div class="value success" id="completed-jw-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Job Work Pending</h3>
                            <div class="value warning" id="pending-jw-orders">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Total Job Cards</h3>
                            <div class="value" id="total-job-cards">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Total Assemblies</h3>
                            <div class="value" id="total-assemblies">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Assemblies Completed</h3>
                            <div class="value success" id="completed-assemblies">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Assemblies Pending</h3>
                            <div class="value warning" id="pending-assemblies">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Low Stock Items</h3>
                            <div class="value error" id="low-stock-count">0</div>
                        </div>
                        <div class="stat-box">
                            <h3>Total Rejected (Rework)</h3>
                            <div class="value warning" id="total-rejected">0</div>
                        </div>
                    </div>
                </div>

                <!-- Current Stock Status -->
                <div class="card">
                    <h2>üì¶ Current Stock Status (Real-Time)</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Component ID</th>
                                    <th>Component Name</th>
                                    <th>Opening Stock</th>
                                    <th>From Foundry (Accepted)</th>
                                    <th>To Job Work (Sent)</th>
                                    <th>Rejected (Rework)</th>
                                    <th>To Assembly (Completed)</th>
                                    <th>Closing Stock</th>
                                    <th>Min Level</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="stock-dashboard-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Foundry Orders Summary -->
                <div class="card">
                    <h2>üî© Foundry Orders Summary</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order No</th>
                                    <th>Component</th>
                                    <th>Qty Ordered</th>
                                    <th>Total Received</th>
                                    <th>Total Accepted</th>
                                    <th>Total Rejected</th>
                                    <th>Pending</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="fo-summary-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Job Work Summary -->
                <div class="card">
                    <h2>‚öôÔ∏è Job Work Summary</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order No</th>
                                    <th>Component</th>
                                    <th>Qty Sent</th>
                                    <th>Total Received</th>
                                    <th>Total Accepted</th>
                                    <th>Total Rejected</th>
                                    <th>Pending</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="jw-summary-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Assembly Summary -->
                <div class="card">
                    <h2>üîß Assembly Summary</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Job Card</th>
                                    <th>Component</th>
                                    <th>Required (from BOM)</th>
                                    <th>Assembled</th>
                                    <th>Pending</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="assembly-summary-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Analysis & Order Planning -->
                <div class="card">
                    <h2>üìä Stock Analysis & Order Planning</h2>
                    <div class="table-wrapper">
                        <table class="planning-table">
                            <thead>
                                <tr>
                                    <th>Component ID</th>
                                    <th>Component Name</th>
                                    <th>Current Stock</th>
                                    <th>Required (from Job Cards)</th>
                                    <th>Shortfall</th>
                                    <th>Lead Time (Days)</th>
                                    <th>Recommended Order Date</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody id="order-planning-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 10-Day Bucket Metrics -->
                <div class="card">
                    <h2>üìÖ 10-Day Bucket Metrics (Monthly) - Visual Cards</h2>
                    <div id="bucket-metrics-container"></div>
                </div>

                <!-- Google Drive Backups History -->
                <div class="card" id="gdriveHistoryCard" style="display: none;">
                    <h2>‚òÅÔ∏è Google Drive Backup History</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Backup Name</th>
                                    <th>Date & Time</th>
                                    <th>File Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gdrive-backup-history">
                                <tr><td colspan="5" style="text-align: center;">No backups yet. Create your first backup!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- MATERIAL MASTER SECTION -->
            <section id="material-master" class="section">
                <div class="card">
                    <h2>üì¶ Item Master</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddMaterialModal()">+ Add Item</button>
                        <button class="btn btn-secondary" onclick="exportMaterialMaster()">üì• Export Items</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="material-search" placeholder="Search items..." onkeyup="filterTable('material-search', 'material-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Component ID</th>
                                    <th>Component Name</th>
                                    <th>Material Type</th>
                                    <th>UOM</th>
                                    <th>Opening Stock</th>
                                    <th>Min Stock</th>
                                    <th>Lead Time</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="material-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VENDOR MASTER SECTION -->
            <section id="vendor-master" class="section">
                <div class="card">
                    <h2>üè¢ Vendor Master</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddVendorModal()">+ Add Vendor</button>
                        <button class="btn btn-secondary" onclick="exportVendorMaster()">üì• Export Vendors</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="vendor-search" placeholder="Search vendors..." onkeyup="filterTable('vendor-search', 'vendor-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Vendor Code</th>
                                    <th>Vendor Name</th>
                                    <th>Contact</th>
                                    <th>City</th>
                                    <th>State</th>
                                    <th>GST/TAX ID</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vendor-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- BOM SECTION -->
            <section id="bom" class="section">
                <div class="card">
                    <h2>üìã Bill of Materials (BOM)</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddBOMModal()">+ Add BOM Entry</button>
                        <button class="btn btn-secondary" onclick="exportBOM()">üì• Export BOM</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Assembly No</th>
                                    <th>Component ID</th>
                                    <th>Component Name</th>
                                    <th>Required Qty</th>
                                    <th>UOM</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bom-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- FOUNDRY ORDER SECTION -->
            <section id="foundry-order" class="section">
                <div class="card">
                    <h2>üî© Foundry Orders</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddFoundryOrderModal()">+ New Foundry Order</button>
                        <button class="btn btn-secondary" onclick="exportFoundryOrder()">üì• Export Orders</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="fo-search" placeholder="Search orders..." onkeyup="filterTable('fo-search', 'fo-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order No</th>
                                    <th>Order Date</th>
                                    <th>Supplier</th>
                                    <th>Component</th>
                                    <th>Qty Ordered</th>
                                    <th>Due Date</th>
                                    <th>Total Received</th>
                                    <th>Pending</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fo-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2>üì• Foundry Lot Tracking (Editable)</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddFoundryLotModal()">+ Add Lot</button>
                        <button class="btn btn-secondary" onclick="exportFoundryLots()">üì• Export Lots</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order No</th>
                                    <th>Lot No</th>
                                    <th>Batch ID</th>
                                    <th>Received Date</th>
                                    <th>Received Qty</th>
                                    <th>Accepted Qty</th>
                                    <th>Rejected Qty</th>
                                    <th>Inspection Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fo-lot-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- JOB WORK ORDER SECTION -->
            <section id="job-work" class="section">
                <div class="card">
                    <h2>‚öôÔ∏è Job Work Orders</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddJobWorkModal()">+ New Job Work Order</button>
                        <button class="btn btn-secondary" onclick="exportJobWork()">üì• Export Job Orders</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="jw-search" placeholder="Search orders..." onkeyup="filterTable('jw-search', 'jw-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order No</th>
                                    <th>Order Date</th>
                                    <th>Subcontractor</th>
                                    <th>Component</th>
                                    <th>Nature of Work</th>
                                    <th>Qty Sent (Max Available)</th>
                                    <th>Due Date</th>
                                    <th>Total Received</th>
                                    <th>Pending</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jw-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2>üì• Job Work Lot Tracking (Editable)</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddJobWorkLotModal()">+ Add Lot</button>
                        <button class="btn btn-secondary" onclick="exportJobWorkLots()">üì• Export Lots</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ref Order No</th>
                                    <th>Lot No</th>
                                    <th>Batch ID</th>
                                    <th>Received Date</th>
                                    <th>Received Qty</th>
                                    <th>Accepted Qty</th>
                                    <th>Rejected Qty</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jw-lot-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- JOB CARD SECTION -->
            <section id="job-card" class="section">
                <div class="card">
                    <h2>üìë Job Cards</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddJobCardModal()">+ Create Job Card</button>
                        <button class="btn btn-secondary" onclick="exportJobCard()">üì• Export Job Cards</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="jc-search" placeholder="Search cards..." onkeyup="filterTable('jc-search', 'jc-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Job Card No</th>
                                    <th>Date</th>
                                    <th>Assemblies</th>
                                    <th>Total Components</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jc-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ASSEMBLY SECTION -->
            <section id="assembly" class="section">
                <div class="card">
                    <h2>üîß Assembly Operations (Auto-Generated from Job Cards)</h2>
                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="exportAssembly()">üì• Export Assembly</button>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="assembly-search" placeholder="Search assemblies..." onkeyup="filterTable('assembly-search', 'assembly-body')">
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Assembly No</th>
                                    <th>Job Card</th>
                                    <th>Component</th>
                                    <th>Required Qty (from BOM)</th>
                                    <th>Assembled Qty</th>
                                    <th>Pending Qty</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assembly-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- BACKUP & RESTORE SECTION -->
            <section id="backup-restore" class="section">
                <div class="card">
                    <h2>‚òÅÔ∏è Local Backup & Restore Data</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="backupDataNow()">üíæ Backup Now (Local)</button>
                        <button class="btn btn-secondary" onclick="restoreDataNow()">üíæ Restore from Local Backup</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <h3>Local Backup Information</h3>
                        <p><strong>Last Backup:</strong> <span id="last-backup-time">Never</span></p>
                        <p><strong>Backup Size:</strong> <span id="backup-size">0 bytes</span></p>
                        <p style="color: var(--color-text-secondary); font-size: 12px;">üìù Local backup stores data in browser cache.</p>
                    </div>
                </div>

                <div class="card">
                    <h2>‚òÅÔ∏è Google Drive Backup & Restore</h2>
                    <div id="gdrive-section" style="display: none;">
                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="backupToGoogleDrive()">‚òÅÔ∏è Backup to Google Drive</button>
                            <button class="btn btn-secondary" onclick="restoreFromGoogleDrive()">‚òÅÔ∏è Restore from Google Drive</button>
                            <button class="btn btn-secondary" onclick="listGoogleDriveBackups()">üìã List All Backups</button>
                            <button class="btn btn-secondary" onclick="googleLogout()">üö™ Sign Out from Google</button>
                        </div>
                        <div style="margin-top: 20px;">
                            <h3>Google Drive Status</h3>
                            <p><strong>Account:</strong> <span id="gdrive-account">Not connected</span></p>
                            <p><strong>Total Backups:</strong> <span id="gdrive-backup-count">0</span></p>
                            <p id="gdrive-last-backup" style="display: none;"><strong>Last Backup:</strong> <span id="gdrive-last-backup-time">-</span></p>
                            <p style="color: var(--color-text-secondary); font-size: 12px;">üîê Secure cloud backup using your Google Drive account. Data synced automatically.</p>
                        </div>
                    </div>
                    <div id="gdrive-signin" style="margin-top: 20px; text-align: center;">
                        <p style="margin-bottom: 15px; color: var(--color-text-secondary);">Sign in with Google to enable cloud backup:</p>
                        <button id="googleSignInBtn" class="btn btn-primary" onclick="initGoogleSignIn()">üîê Sign In with Google Drive</button>
                    </div>
                </div>
            </section>

            <!-- USER MANAGEMENT SECTION -->
            <section id="user-management" class="section">
                <div class="card">
                    <h2>üë• User Management</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="showAddUserModal()">+ Add New User</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Created/Updated</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- ADD MATERIAL MODAL -->
    <div id="addMaterialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Item</h2>
                <button class="modal-close" onclick="closeModal('addMaterialModal')">√ó</button>
            </div>
            <form onsubmit="saveMaterial(event)">
                <div class="form-group">
                    <label>Component ID *</label>
                    <input type="text" id="mat-id" required>
                </div>
                <div class="form-group">
                    <label>Component Name *</label>
                    <input type="text" id="mat-name" required>
                </div>
                <div class="form-group">
                    <label>Material Type</label>
                    <select id="mat-type">
                        <option>Cast Iron</option>
                        <option>Stainless Steel</option>
                        <option>Aluminium</option>
                        <option>Mild Steel</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>UOM</label>
                    <input type="text" id="mat-uom" value="Pcs">
                </div>
                <div class="form-group">
                    <label>Opening Stock</label>
                    <input type="number" id="mat-opening-stock" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Min Stock Level</label>
                    <input type="number" id="mat-min-stock" value="50" min="0">
                </div>
                <div class="form-group">
                    <label>Lead Time (Days)</label>
                    <input type="number" id="mat-lead-time" value="7" min="0">
                </div>
                <div class="form-group">
                    <label>Component Price</label>
                    <input type="number" id="mat-price" step="0.01" value="0">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addMaterialModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD VENDOR MODAL -->
    <div id="addVendorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Vendor</h2>
                <button class="modal-close" onclick="closeModal('addVendorModal')">√ó</button>
            </div>
            <form onsubmit="saveVendor(event)">
                <div class="form-group">
                    <label>Vendor Code *</label>
                    <input type="text" id="vendor-code" required>
                </div>
                <div class="form-group">
                    <label>Vendor Name *</label>
                    <input type="text" id="vendor-name" required>
                </div>
                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="vendor-contact">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="vendor-city">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="vendor-state">
                </div>
                <div class="form-group">
                    <label>GST/TAX ID</label>
                    <input type="text" id="vendor-gst">
                </div>
                <div class="form-group">
                    <label>Vendor Rating (1-5)</label>
                    <select id="vendor-rating">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option selected>4</option>
                        <option>5</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addVendorModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD BOM MODAL -->
    <div id="addBOMModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add BOM Entry</h2>
                <button class="modal-close" onclick="closeModal('addBOMModal')">√ó</button>
            </div>
            <form onsubmit="saveBOM(event)">
                <div class="form-group">
                    <label>Assembly No *</label>
                    <input type="text" id="bom-assembly-no" placeholder="Example: AS-001" required>
                </div>
                <div class="form-group">
                    <label>Component *</label>
                    <select id="bom-component" required></select>
                </div>
                <div class="form-group">
                    <label>Required Qty *</label>
                    <input type="number" id="bom-qty" required min="1">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addBOMModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD FOUNDRY ORDER MODAL -->
    <div id="addFoundryOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Foundry Order</h2>
                <button class="modal-close" onclick="closeModal('addFoundryOrderModal')">√ó</button>
            </div>
            <form onsubmit="saveFoundryOrder(event)">
                <div class="form-group">
                    <label>Order No *</label>
                    <input type="text" id="fo-order-no" required>
                </div>
                <div class="form-group">
                    <label>Order Date *</label>
                    <input type="date" id="fo-order-date" required>
                </div>
                <div class="form-group">
                    <label>Supplier *</label>
                    <select id="fo-supplier" required></select>
                </div>
                <div class="form-group">
                    <label>Component *</label>
                    <select id="fo-component" required></select>
                </div>
                <div class="form-group">
                    <label>Qty Ordered *</label>
                    <input type="number" id="fo-qty-ordered" required min="1">
                </div>
                <div class="form-group">
                    <label>Expected Due Date</label>
                    <input type="date" id="fo-expected-due">
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea id="fo-remarks" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addFoundryOrderModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD FOUNDRY LOT MODAL -->
    <div id="addFoundryLotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Foundry Lot</h2>
                <button class="modal-close" onclick="closeModal('addFoundryLotModal')">√ó</button>
            </div>
            <form onsubmit="saveFoundryLot(event)">
                <div class="form-group">
                    <label>Order No *</label>
                    <select id="fo-lot-order-no" required></select>
                </div>
                <div class="form-group">
                    <label>Batch ID *</label>
                    <input type="text" id="fo-lot-batch-id" required>
                </div>
                <div class="form-group">
                    <label>Received Date *</label>
                    <input type="date" id="fo-lot-received-date" required>
                </div>
                <div class="form-group">
                    <label>Received Qty *</label>
                    <input type="number" id="fo-lot-received-qty" required min="1">
                </div>
                <div class="form-group">
                    <label>Accepted Qty *</label>
                    <input type="number" id="fo-lot-accepted-qty" required min="0">
                </div>
                <div class="form-group">
                    <label>Rejected Qty *</label>
                    <input type="number" id="fo-lot-rejected-qty" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Inspection Status</label>
                    <select id="fo-lot-inspection">
                        <option>Pending</option>
                        <option selected>Passed</option>
                        <option>Partial</option>
                        <option>Failed</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addFoundryLotModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD JOB WORK ORDER MODAL -->
    <div id="addJobWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Job Work Order</h2>
                <button class="modal-close" onclick="closeModal('addJobWorkModal')">√ó</button>
            </div>
            <form onsubmit="saveJobWork(event)">
                <div class="form-group">
                    <label>Order No *</label>
                    <input type="text" id="jw-order-no" required>
                </div>
                <div class="form-group">
                    <label>Order Date *</label>
                    <input type="date" id="jw-order-date" required>
                </div>
                <div class="form-group">
                    <label>Subcontractor *</label>
                    <select id="jw-subcontractor" required></select>
                </div>
                <div class="form-group">
                    <label>Component *</label>
                    <select id="jw-component" required></select>
                </div>
                <div class="form-group">
                    <label>Nature of Work</label>
                    <select id="jw-nature">
                        <option>Drilling</option>
                        <option>Machining</option>
                        <option>Balancing</option>
                        <option>Tapping</option>
                        <option>Finishing</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Qty Sent (Max available from Foundry) *</label>
                    <input type="number" id="jw-qty-sent" required min="1">
                    <small style="color: var(--color-text-secondary);">Max available: <span id="jw-max-available">0</span> units</small>
                </div>
                <div class="form-group">
                    <label>Expected Due Date</label>
                    <input type="date" id="jw-expected-due">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addJobWorkModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD JOB WORK LOT MODAL -->
    <div id="addJobWorkLotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Job Work Lot</h2>
                <button class="modal-close" onclick="closeModal('addJobWorkLotModal')">√ó</button>
            </div>
            <form onsubmit="saveJobWorkLot(event)">
                <div class="form-group">
                    <label>Ref Order No *</label>
                    <select id="jw-lot-order-no" required></select>
                </div>
                <div class="form-group">
                    <label>Lot No *</label>
                    <input type="text" id="jw-lot-lot-no" required>
                </div>
                <div class="form-group">
                    <label>Batch ID *</label>
                    <input type="text" id="jw-lot-batch-id" required>
                </div>
                <div class="form-group">
                    <label>Received Date *</label>
                    <input type="date" id="jw-lot-received-date" required>
                </div>
                <div class="form-group">
                    <label>Received Qty *</label>
                    <input type="number" id="jw-lot-received-qty" required min="1">
                </div>
                <div class="form-group">
                    <label>Accepted Qty *</label>
                    <input type="number" id="jw-lot-accepted-qty" required min="0">
                </div>
                <div class="form-group">
                    <label>Rejected Qty (for Rework) *</label>
                    <input type="number" id="jw-lot-rejected-qty" value="0" min="0">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addJobWorkLotModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD JOB CARD MODAL -->
    <div id="addJobCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Job Card</h2>
                <button class="modal-close" onclick="closeModal('addJobCardModal')">√ó</button>
            </div>
            <form onsubmit="saveJobCard(event)">
                <div class="form-group">
                    <label>Job Card No *</label>
                    <input type="text" id="jc-no" placeholder="JC-001" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="jc-date" required>
                </div>
                <h3 style="margin-top: 20px;">Select Assemblies & Quantities</h3>
                <div id="jc-assembly-selector"></div>
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create Job Card & Assemblies</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addJobCardModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD USER MODAL -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="modal-close" onclick="closeModal('addUserModal')">√ó</button>
            </div>
            <form onsubmit="saveNewUser(event)">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="new-username" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="new-password" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="new-confirm-password" required>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add User</button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal('addUserModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // AUTHENTICATION SYSTEM
        // ============================================================================
        let currentUser = null;
        let loginMode = 'signin';

        function initAuth() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            loginMode = Object.keys(users).length === 0 ? 'signup' : 'signin';
            showLoginForm();
        }

        function toggleLoginMode() {
            loginMode = loginMode === 'signin' ? 'signup' : 'signin';
            showLoginForm();
        }

        function showLoginForm() {
            const modeText = document.getElementById('loginModeText');
            const confirmGroup = document.getElementById('confirmPasswordGroup');

            if (loginMode === 'signin') {
                modeText.textContent = 'Sign In';
                confirmGroup.style.display = 'none';
            } else {
                modeText.textContent = 'Create Account';
                confirmGroup.style.display = 'block';
            }
            clearLoginForm();
        }

        function clearLoginForm() {
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginConfirmPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const confirmPassword = document.getElementById('loginConfirmPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = '‚ùå Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');

            if (loginMode === 'signin') {
                if (!users[username] || users[username] !== password) {
                    errorDiv.textContent = '‚ùå Invalid username or password';
                    errorDiv.style.display = 'block';
                    return;
                }
            } else {
                if (users[username]) {
                    errorDiv.textContent = '‚ùå Username already exists';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (password !== confirmPassword) {
                    errorDiv.textContent = '‚ùå Passwords do not match';
                    errorDiv.style.display = 'block';
                    return;
                }
                users[username] = password;
                localStorage.setItem('users', JSON.stringify(users));
            }

            currentUser = username;
            localStorage.setItem('currentUser', username);
            showApp();
        }

        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('currentUser').textContent = currentUser;
            initApp();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('appContainer').classList.remove('active');
                document.getElementById('loginContainer').style.display = 'flex';
                showLoginForm();
            }
        }

        // ============================================================================
        // DATA STRUCTURE
        // ============================================================================
        const app = {
            materials: [],
            vendors: [],
            bom: [],
            foundryOrders: [],
            foundryLots: [],
            jobWorkOrders: [],
            jobWorkLots: [],
            jobCards: [],
            assemblies: []
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        function initApp() {
            loadDataFromStorage();
            if (app.materials.length === 0) {
                loadDefaultData();
            }
            renderAllSections();
        }

        function loadDefaultData() {
            app.materials = [
                {id: '1001.01.01', name: 'Volute CI', type: 'Cast Iron', uom: 'Pcs', openingStock: 100, minStock: 50, leadTime: 7, price: 500},
                {id: '1001.02.01', name: 'Volute SS', type: 'Stainless Steel', uom: 'Pcs', openingStock: 75, minStock: 50, leadTime: 10, price: 800},
                {id: '1002.01.01', name: 'Bearing Housing', type: 'Cast Iron', uom: 'Pcs', openingStock: 50, minStock: 50, leadTime: 7, price: 450},
                {id: '1003.01.01', name: 'Bearing Cover', type: 'Cast Iron', uom: 'Pcs', openingStock: 80, minStock: 50, leadTime: 7, price: 300},
                {id: '1004.01.01', name: 'VM Body', type: 'Cast Iron', uom: 'Pcs', openingStock: 60, minStock: 50, leadTime: 7, price: 600},
                {id: '1005.01.01', name: 'VM Side Cover', type: 'Cast Iron', uom: 'Pcs', openingStock: 100, minStock: 50, leadTime: 7, price: 350},
                {id: '1008.01.01', name: 'Stuffing Box', type: 'Stainless Steel', uom: 'Pcs', openingStock: 120, minStock: 50, leadTime: 10, price: 450}
            ];

            app.vendors = [
                {code: '1001', name: 'GNS Foundry', contact: 'Hari', city: 'Coimbatore', state: 'TN', gst: '33b543a', rating: 5},
                {code: '1002', name: 'HI-PREE Castings', contact: 'Sugan', city: 'Coimbatore', state: 'TN', gst: '33b543B', rating: 4},
                {code: '1003', name: 'Prime Job Works', contact: 'Kumar', city: 'Coimbatore', state: 'TN', gst: '33b543C', rating: 4}
            ];

            app.bom = [
                {assemblyNo: 'AS-001', componentId: '1001.01.01', requiredQty: 2},
                {assemblyNo: 'AS-001', componentId: '1002.01.01', requiredQty: 3},
                {assemblyNo: 'AS-002', componentId: '1005.01.01', requiredQty: 4},
                {assemblyNo: 'AS-003', componentId: '1008.01.01', requiredQty: 1},
                {assemblyNo: 'AS-003', componentId: '1001.02.01', requiredQty: 2}
            ];

            app.foundryOrders = [
                {orderNo: 'FD-001', date: '2025-12-23', supplierCode: '1001', supplierName: 'GNS Foundry', componentId: '1001.01.01', componentName: 'Volute CI', qtyOrdered: 100, expectedDue: '2025-12-28', remarks: 'Standard order'}
            ];

            app.foundryLots = [
                {id: 'FOL-001', orderNo: 'FD-001', lotNo: '1', batchId: 'BATCH-20251223-001', receivedDate: '2025-12-23', receivedQty: 100, acceptedQty: 95, rejectedQty: 5, inspectionStatus: 'Passed'}
            ];

            saveDataToStorage();
        }

        // ============================================================================
        // STOCK CALCULATION - CORE LOGIC
        // ============================================================================
        function calculateFromFoundryAccepted(componentId) {
            return app.foundryLots.filter(lot => {
                const order = app.foundryOrders.find(o => o.orderNo === lot.orderNo);
                return order && order.componentId === componentId;
            }).reduce((sum, lot) => sum + lot.acceptedQty, 0);
        }

        function calculateToJobWorkSent(componentId) {
            return app.jobWorkOrders.filter(jw => jw.componentId === componentId)
                .reduce((sum, jw) => sum + jw.qtySent, 0);
        }

        function calculateToJobWorkAccepted(componentId) {
            return app.jobWorkLots.filter(lot => {
                const order = app.jobWorkOrders.find(o => o.orderNo === lot.refOrderNo);
                return order && order.componentId === componentId;
            }).reduce((sum, lot) => sum + lot.acceptedQty, 0);
        }

        function calculateRejected(componentId) {
            return app.jobWorkLots.filter(lot => {
                const order = app.jobWorkOrders.find(o => o.orderNo === lot.refOrderNo);
                return order && order.componentId === componentId;
            }).reduce((sum, lot) => sum + lot.rejectedQty, 0);
        }

        function calculateToAssemblyCompleted(componentId) {
            return app.assemblies.filter(a => a.componentId === componentId)
                .reduce((sum, a) => sum + a.assembledQty, 0);
        }

        function calculateClosingStock(componentId) {
            const mat = app.materials.find(m => m.id === componentId);
            if (!mat) return 0;
            
            const fromFoundry = calculateFromFoundryAccepted(componentId);
            const rejected = calculateRejected(componentId);
            const toAssembly = calculateToAssemblyCompleted(componentId);

            return mat.openingStock + fromFoundry + rejected - toAssembly;
        }

        function getAvailableForJobWork(componentId) {
            const mat = app.materials.find(m => m.id === componentId);
            if (!mat) return 0;
            
            const fromFoundry = calculateFromFoundryAccepted(componentId);
            const alreadySent = calculateToJobWorkSent(componentId);
            
            return Math.max(0, mat.openingStock + fromFoundry - alreadySent);
        }

        function getAvailableForAssembly(componentId) {
            const closing = calculateClosingStock(componentId);
            return Math.max(0, closing);
        }

        // ============================================================================
        // RENDER FUNCTIONS
        // ============================================================================
        function renderAllSections() {
            renderDashboard();
            renderMaterialMaster();
            renderVendorMaster();
            renderBOM();
            renderFoundryOrder();
            renderJobWork();
            renderJobCard();
            renderAssembly();
            renderUserManagement();
            checkStockLevels();
            updateBackupInfo();
        }

        function renderDashboard() {
            document.getElementById('total-fo-orders').textContent = app.foundryOrders.length;
            
            const completedFO = app.foundryOrders.filter(o => {
                const totalReceived = app.foundryLots
                    .filter(lot => lot.orderNo === o.orderNo)
                    .reduce((sum, lot) => sum + lot.acceptedQty, 0);
                return totalReceived >= o.qtyOrdered;
            }).length;
            document.getElementById('completed-fo-orders').textContent = completedFO;
            document.getElementById('pending-fo-orders').textContent = app.foundryOrders.length - completedFO;

            document.getElementById('total-jw-orders').textContent = app.jobWorkOrders.length;
            
            const completedJW = app.jobWorkOrders.filter(o => {
                const totalAccepted = app.jobWorkLots
                    .filter(lot => lot.refOrderNo === o.orderNo)
                    .reduce((sum, lot) => sum + lot.acceptedQty, 0);
                return totalAccepted >= o.qtySent;
            }).length;
            document.getElementById('completed-jw-orders').textContent = completedJW;
            document.getElementById('pending-jw-orders').textContent = app.jobWorkOrders.length - completedJW;

            const uniqueAssemblyBases = new Set();
            app.jobCards.forEach(card => {
                card.assemblies.forEach(a => {
                    uniqueAssemblyBases.add(a.assemblyNo);
                });
            });
            document.getElementById('total-job-cards').textContent = app.jobCards.length;
            
            const assemblyStatus = getAssemblyBaseStatus();
            document.getElementById('total-assemblies').textContent = assemblyStatus.total;
            document.getElementById('completed-assemblies').textContent = assemblyStatus.completed;
            document.getElementById('pending-assemblies').textContent = assemblyStatus.pending;

            const lowStockCount = app.materials.filter(m => calculateClosingStock(m.id) < m.minStock).length;
            document.getElementById('low-stock-count').textContent = lowStockCount;

            const totalRejected = app.jobWorkLots.reduce((sum, lot) => sum + lot.rejectedQty, 0);
            document.getElementById('total-rejected').textContent = totalRejected;

            renderOrderPlanning();
            renderBucketMetricsCards();

            let html = '';
            app.materials.forEach(mat => {
                const fromFoundry = calculateFromFoundryAccepted(mat.id);
                const toJobWork = calculateToJobWorkSent(mat.id);
                const rejected = calculateRejected(mat.id);
                const toAssembly = calculateToAssemblyCompleted(mat.id);
                const closing = calculateClosingStock(mat.id);
                
                let statusClass = closing >= mat.minStock ? 'healthy' : closing >= 20 ? 'warning' : 'critical';
                let statusText = closing >= mat.minStock ? '‚úì OK' : '‚ö†Ô∏è LOW';
                
                html += `<tr>
                    <td>${mat.id}</td>
                    <td>${mat.name}</td>
                    <td>${mat.openingStock}</td>
                    <td>${fromFoundry}</td>
                    <td>${toJobWork}</td>
                    <td>${rejected}</td>
                    <td>${toAssembly}</td>
                    <td><strong>${closing}</strong></td>
                    <td>${mat.minStock}</td>
                    <td><span class="stock-level ${statusClass}">${statusText}</span></td>
                </tr>`;
            });
            document.getElementById('stock-dashboard-body').innerHTML = html;

            html = '';
            app.foundryOrders.forEach(o => {
                const lots = app.foundryLots.filter(lot => lot.orderNo === o.orderNo);
                const totalReceived = lots.reduce((sum, lot) => sum + lot.receivedQty, 0);
                const totalAccepted = lots.reduce((sum, lot) => sum + lot.acceptedQty, 0);
                const totalRejected = lots.reduce((sum, lot) => sum + lot.rejectedQty, 0);
                const pending = o.qtyOrdered - totalAccepted;
                
                let status = pending === 0 ? 'Completed' : pending === o.qtyOrdered ? 'Pending' : 'In Progress';
                let badgeClass = pending === 0 ? 'badge-success' : pending === o.qtyOrdered ? 'badge-error' : 'badge-warning';
                
                html += `<tr>
                    <td>${o.orderNo}</td>
                    <td>${o.componentName}</td>
                    <td>${o.qtyOrdered}</td>
                    <td>${totalReceived}</td>
                    <td>${totalAccepted}</td>
                    <td>${totalRejected}</td>
                    <td>${pending}</td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                </tr>`;
            });
            document.getElementById('fo-summary-body').innerHTML = html || '<tr><td colspan="8" style="text-align: center;">No foundry orders yet</td></tr>';

            html = '';
            app.jobWorkOrders.forEach(o => {
                const lots = app.jobWorkLots.filter(lot => lot.refOrderNo === o.orderNo);
                const totalReceived = lots.reduce((sum, lot) => sum + lot.receivedQty, 0);
                const totalAccepted = lots.reduce((sum, lot) => sum + lot.acceptedQty, 0);
                const totalRejected = lots.reduce((sum, lot) => sum + lot.rejectedQty, 0);
                const pending = o.qtySent - totalAccepted;
                
                let status = pending === 0 ? 'Completed' : pending === o.qtySent ? 'Pending' : 'In Progress';
                let badgeClass = pending === 0 ? 'badge-success' : pending === o.qtySent ? 'badge-error' : 'badge-warning';
                
                html += `<tr>
                    <td>${o.orderNo}</td>
                    <td>${o.componentName}</td>
                    <td>${o.qtySent}</td>
                    <td>${totalReceived}</td>
                    <td>${totalAccepted}</td>
                    <td>${totalRejected}</td>
                    <td>${pending}</td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                </tr>`;
            });
            document.getElementById('jw-summary-body').innerHTML = html || '<tr><td colspan="8" style="text-align: center;">No job work orders yet</td></tr>';

            html = '';
            const assemblyGrouped = {};
            app.assemblies.forEach(a => {
                const key = `${a.jobCard}_${a.componentId}`;
                if (!assemblyGrouped[key]) {
                    assemblyGrouped[key] = {jobCard: a.jobCard, componentId: a.componentId, componentName: a.componentName, required: 0, assembled: 0};
                }
                assemblyGrouped[key].required += a.requiredQty;
                assemblyGrouped[key].assembled += a.assembledQty;
            });

            Object.values(assemblyGrouped).forEach(item => {
                const pending = item.required - item.assembled;
                const status = pending === 0 ? 'Completed' : pending === item.required ? 'Pending' : 'In Progress';
                const badgeClass = pending === 0 ? 'badge-success' : pending === item.required ? 'badge-error' : 'badge-warning';
                
                html += `<tr>
                    <td>${item.jobCard}</td>
                    <td>${item.componentName}</td>
                    <td>${item.required}</td>
                    <td>${item.assembled}</td>
                    <td>${pending}</td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                </tr>`;
            });
            document.getElementById('assembly-summary-body').innerHTML = html || '<tr><td colspan="6" style="text-align: center;">No assemblies yet</td></tr>';
        }

        function getAssemblyBaseStatus() {
            const assemblyBases = {};
            
            app.jobCards.forEach(card => {
                card.assemblies.forEach(selection => {
                    const baseNo = selection.assemblyNo;
                    if (!assemblyBases[baseNo]) {
                        assemblyBases[baseNo] = {
                            base: baseNo,
                            totalRequired: 0,
                            totalAssembled: 0,
                            componentDetails: []
                        };
                    }
                    
                    const bomEntries = app.bom.filter(b => b.assemblyNo === baseNo);
                    bomEntries.forEach(bom => {
                        const requiredPerUnit = bom.requiredQty;
                        assemblyBases[baseNo].totalRequired += requiredPerUnit * selection.qty;
                        
                        const assembledForComponent = app.assemblies
                            .filter(a => a.assemblyNo.startsWith(baseNo) && a.componentId === bom.componentId)
                            .reduce((sum, a) => sum + a.assembledQty, 0);
                        assemblyBases[baseNo].totalAssembled += assembledForComponent;
                    });
                });
            });

            let total = 0, completed = 0, pending = 0;
            Object.values(assemblyBases).forEach(base => {
                total++;
                if (base.totalAssembled >= base.totalRequired && base.totalRequired > 0) {
                    completed++;
                } else if (base.totalAssembled === 0) {
                    pending++;
                }
            });

            return {total, completed, pending};
        }

        function renderOrderPlanning() {
            if (app.jobCards.length === 0) {
                document.getElementById('order-planning-body').innerHTML = '<tr><td colspan="8" style="text-align: center;">No active job cards. Create job cards to see planning.</td></tr>';
                return;
            }

            const planningMap = {};
            
            app.jobCards.forEach(card => {
                card.assemblies.forEach(selection => {
                    const bomEntries = app.bom.filter(b => b.assemblyNo === selection.assemblyNo);
                    bomEntries.forEach(bom => {
                        if (!planningMap[bom.componentId]) {
                            const mat = app.materials.find(m => m.id === bom.componentId);
                            planningMap[bom.componentId] = {
                                id: bom.componentId,
                                name: mat ? mat.name : 'Unknown',
                                current: calculateClosingStock(bom.componentId),
                                required: 0,
                                leadTime: mat ? mat.leadTime : 7
                            };
                        }
                        planningMap[bom.componentId].required += bom.requiredQty * selection.qty;
                    });
                });
            });

            let html = '';
            Object.values(planningMap).forEach(item => {
                const shortfall = Math.max(0, item.required - item.current);
                let priority = 'Low';
                let priorityClass = 'priority-low';
                
                if (shortfall > 0) {
                    if (shortfall >= item.required * 0.75) {
                        priority = 'Urgent';
                        priorityClass = 'priority-urgent';
                    } else if (shortfall >= item.required * 0.50) {
                        priority = 'High';
                        priorityClass = 'priority-high';
                    } else {
                        priority = 'Normal';
                        priorityClass = 'priority-normal';
                    }
                } else {
                    priority = 'Low';
                    priorityClass = 'priority-low';
                }

                const today = new Date();
                const orderDate = new Date(today.getTime() - (item.leadTime * 24 * 60 * 60 * 1000));
                const orderDateStr = orderDate.toISOString().split('T')[0];
                
                html += `<tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.current}</td>
                    <td>${item.required}</td>
                    <td><strong>${shortfall}</strong></td>
                    <td>${item.leadTime} days</td>
                    <td>${orderDateStr}</td>
                    <td><span class="${priorityClass}">${priority}</span></td>
                </tr>`;
            });

            document.getElementById('order-planning-body').innerHTML = html || '<tr><td colspan="8" style="text-align: center;">No planning data available</td></tr>';
        }

        function renderBucketMetricsCards() {
            const buckets = [
                {name: 'Period 1', days: '1-10'},
                {name: 'Period 2', days: '11-20'},
                {name: 'Period 3', days: '21-31'}
            ];

            let html = '<div class="bucket-metrics-container">';
            
            buckets.forEach(bucket => {
                let foReceived = 0, foAccepted = 0, foRejected = 0;
                let jwReceived = 0, jwAccepted = 0, jwRejected = 0;
                let assemblyCompleted = 0;

                app.foundryLots.forEach(lot => {
                    const date = new Date(lot.receivedDate);
                    const day = date.getDate();
                    if ((bucket.name === 'Period 1' && day >= 1 && day <= 10) ||
                        (bucket.name === 'Period 2' && day >= 11 && day <= 20) ||
                        (bucket.name === 'Period 3' && day >= 21)) {
                        foReceived += lot.receivedQty;
                        foAccepted += lot.acceptedQty;
                        foRejected += lot.rejectedQty;
                    }
                });

                app.jobWorkLots.forEach(lot => {
                    const date = new Date(lot.receivedDate);
                    const day = date.getDate();
                    if ((bucket.name === 'Period 1' && day >= 1 && day <= 10) ||
                        (bucket.name === 'Period 2' && day >= 11 && day <= 20) ||
                        (bucket.name === 'Period 3' && day >= 21)) {
                        jwReceived += lot.receivedQty;
                        jwAccepted += lot.acceptedQty;
                        jwRejected += lot.rejectedQty;
                    }
                });

                const assemblyBases = {};
                app.jobCards.forEach(card => {
                    card.assemblies.forEach(selection => {
                        const baseNo = selection.assemblyNo;
                        if (!assemblyBases[baseNo]) {
                            assemblyBases[baseNo] = {totalRequired: 0, totalAssembled: 0};
                        }
                        const bomEntries = app.bom.filter(b => b.assemblyNo === baseNo);
                        bomEntries.forEach(bom => {
                            assemblyBases[baseNo].totalRequired += bom.requiredQty * selection.qty;
                            const assembledForComponent = app.assemblies
                                .filter(a => a.assemblyNo.startsWith(baseNo) && a.componentId === bom.componentId)
                                .reduce((sum, a) => sum + a.assembledQty, 0);
                            assemblyBases[baseNo].totalAssembled += assembledForComponent;
                        });
                    });
                });

                assemblyCompleted = Object.values(assemblyBases).filter(base => 
                    base.totalAssembled >= base.totalRequired && base.totalRequired > 0
                ).length;

                const foEfficiency = foReceived > 0 ? Math.round((foAccepted / foReceived) * 100) : 0;
                const jwEfficiency = jwReceived > 0 ? Math.round((jwAccepted / jwReceived) * 100) : 0;

                html += `
                <div class="bucket-card">
                    <div class="bucket-header">${bucket.name} (Days ${bucket.days})</div>
                    <div class="bucket-metrics">
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">üì• Foundry Received</div>
                                <div class="metric-value">${foReceived}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">‚úì Foundry Accepted</div>
                                <div class="metric-value success">${foAccepted}</div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">‚úï Foundry Rejected</div>
                                <div class="metric-value error">${foRejected}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">üìä FO Efficiency</div>
                                <div class="metric-value">${foEfficiency}%</div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">üì• Job Work Received</div>
                                <div class="metric-value">${jwReceived}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">‚úì Job Work Accepted</div>
                                <div class="metric-value success">${jwAccepted}</div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">‚úï Job Work Rejected</div>
                                <div class="metric-value error">${jwRejected}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">üìä JW Efficiency</div>
                                <div class="metric-value">${jwEfficiency}%</div>
                            </div>
                        </div>
                        <div class="metric-row full-row">
                            <div class="metric-item">
                                <div class="metric-label">üîß Assemblies Completed</div>
                                <div class="metric-value success">${assemblyCompleted}</div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div>';

            const container = document.getElementById('bucket-metrics-container');
            if (container) {
                container.innerHTML = html;
            }
        }

        function renderMaterialMaster() {
            let html = '';
            app.materials.forEach(mat => {
                html += `<tr>
                    <td>${mat.id}</td>
                    <td>${mat.name}</td>
                    <td>${mat.type}</td>
                    <td>${mat.uom}</td>
                    <td>${mat.openingStock}</td>
                    <td>${mat.minStock}</td>
                    <td>${mat.leadTime}</td>
                    <td>${mat.price}</td>
                    <td><button class="btn btn-small btn-secondary" onclick="editMaterial('${mat.id}')">Edit</button></td>
                </tr>`;
            });
            document.getElementById('material-body').innerHTML = html;
        }

        function renderVendorMaster() {
            let html = '';
            app.vendors.forEach(v => {
                html += `<tr>
                    <td>${v.code}</td>
                    <td>${v.name}</td>
                    <td>${v.contact}</td>
                    <td>${v.city}</td>
                    <td>${v.state}</td>
                    <td>${v.gst}</td>
                    <td><span class="badge badge-success">${v.rating}/5</span></td>
                    <td><button class="btn btn-small btn-secondary" onclick="editVendor('${v.code}')">Edit</button></td>
                </tr>`;
            });
            document.getElementById('vendor-body').innerHTML = html;
        }

        function renderBOM() {
            let html = '';
            app.bom.forEach((entry, idx) => {
                const comp = app.materials.find(m => m.id === entry.componentId);
                html += `<tr>
                    <td>${entry.assemblyNo}</td>
                    <td>${entry.componentId}</td>
                    <td>${comp ? comp.name : 'N/A'}</td>
                    <td>${entry.requiredQty}</td>
                    <td>${comp ? comp.uom : 'Pcs'}</td>
                    <td><button class="btn btn-small btn-secondary" onclick="deleteBOM(${idx})">Delete</button></td>
                </tr>`;
            });
            document.getElementById('bom-body').innerHTML = html;
        }

        function renderFoundryOrder() {
            let html = '';
            app.foundryOrders.forEach(o => {
                const lots = app.foundryLots.filter(lot => lot.orderNo === o.orderNo);
                const totalReceived = lots.reduce((sum, lot) => sum + lot.receivedQty, 0);
                const totalAccepted = lots.reduce((sum, lot) => sum + lot.acceptedQty, 0);
                const pending = o.qtyOrdered - totalAccepted;
                const status = pending === 0 ? 'Completed' : totalAccepted > 0 ? 'Partial' : 'Pending';
                
                html += `<tr>
                    <td>${o.orderNo}</td>
                    <td>${o.date}</td>
                    <td>${o.supplierName}</td>
                    <td>${o.componentName}</td>
                    <td>${o.qtyOrdered}</td>
                    <td>${o.expectedDue}</td>
                    <td>${totalReceived}</td>
                    <td>${pending}</td>
                    <td><span class="badge badge-${status === 'Completed' ? 'success' : status === 'Partial' ? 'warning' : 'error'}">${status}</span></td>
                    <td><button class="btn btn-small btn-secondary" onclick="editFoundryOrder('${o.orderNo}')">Edit</button></td>
                </tr>`;
            });
            document.getElementById('fo-body').innerHTML = html;

            html = '';
            app.foundryLots.forEach((lot, idx) => {
                html += `<tr>
                    <td>${lot.orderNo}</td>
                    <td>${lot.lotNo}</td>
                    <td><input type="text" value="${lot.batchId}" onchange="updateFoundryLot(${idx}, 'batchId', this.value)" style="width: 120px;"></td>
                    <td><input type="date" value="${lot.receivedDate}" onchange="updateFoundryLot(${idx}, 'receivedDate', this.value)" style="width: 120px;"></td>
                    <td><input type="number" value="${lot.receivedQty}" onchange="updateFoundryLot(${idx}, 'receivedQty', this.value)" style="width: 80px;"></td>
                    <td><input type="number" value="${lot.acceptedQty}" onchange="updateFoundryLot(${idx}, 'acceptedQty', this.value)" style="width: 80px;"></td>
                    <td><input type="number" value="${lot.rejectedQty}" onchange="updateFoundryLot(${idx}, 'rejectedQty', this.value)" style="width: 80px;"></td>
                    <td><select onchange="updateFoundryLot(${idx}, 'inspectionStatus', this.value)">
                        <option ${lot.inspectionStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option ${lot.inspectionStatus === 'Passed' ? 'selected' : ''}>Passed</option>
                        <option ${lot.inspectionStatus === 'Partial' ? 'selected' : ''}>Partial</option>
                        <option ${lot.inspectionStatus === 'Failed' ? 'selected' : ''}>Failed</option>
                    </select></td>
                    <td><button class="btn btn-small btn-secondary" onclick="deleteFoundryLot(${idx})">Delete</button></td>
                </tr>`;
            });
            document.getElementById('fo-lot-body').innerHTML = html;
        }

        function renderJobWork() {
            let html = '';
            app.jobWorkOrders.forEach(o => {
                const lots = app.jobWorkLots.filter(lot => lot.refOrderNo === o.orderNo);
                const totalReceived = lots.reduce((sum, lot) => sum + lot.receivedQty, 0);
                const totalAccepted = lots.reduce((sum, lot) => sum + lot.acceptedQty, 0);
                const pending = o.qtySent - totalAccepted;
                const status = pending === 0 ? 'Completed' : totalAccepted > 0 ? 'Partial' : 'Pending';
                
                html += `<tr>
                    <td>${o.orderNo}</td>
                    <td>${o.date}</td>
                    <td>${o.subName}</td>
                    <td>${o.componentName}</td>
                    <td>${o.nature}</td>
                    <td>${o.qtySent}</td>
                    <td>${o.expectedDue}</td>
                    <td>${totalReceived}</td>
                    <td>${pending}</td>
                    <td><span class="badge badge-${status === 'Completed' ? 'success' : status === 'Partial' ? 'warning' : 'error'}">${status}</span></td>
                    <td><button class="btn btn-small btn-secondary" onclick="editJobWork('${o.orderNo}')">Edit</button></td>
                </tr>`;
            });
            document.getElementById('jw-body').innerHTML = html;

            html = '';
            app.jobWorkLots.forEach((lot, idx) => {
                html += `<tr>
                    <td>${lot.refOrderNo}</td>
                    <td><input type="text" value="${lot.lotNo}" onchange="updateJobWorkLot(${idx}, 'lotNo', this.value)" style="width: 80px;"></td>
                    <td><input type="text" value="${lot.batchId}" onchange="updateJobWorkLot(${idx}, 'batchId', this.value)" style="width: 120px;"></td>
                    <td><input type="date" value="${lot.receivedDate}" onchange="updateJobWorkLot(${idx}, 'receivedDate', this.value)" style="width: 120px;"></td>
                    <td><input type="number" value="${lot.receivedQty}" onchange="updateJobWorkLot(${idx}, 'receivedQty', this.value)" style="width: 80px;"></td>
                    <td><input type="number" value="${lot.acceptedQty}" onchange="updateJobWorkLot(${idx}, 'acceptedQty', this.value)" style="width: 80px;"></td>
                    <td><input type="number" value="${lot.rejectedQty}" onchange="updateJobWorkLot(${idx}, 'rejectedQty', this.value)" style="width: 80px;"></td>
                    <td><button class="btn btn-small btn-secondary" onclick="deleteJobWorkLot(${idx})">Delete</button></td>
                </tr>`;
            });
            document.getElementById('jw-lot-body').innerHTML = html;
        }

        function renderJobCard() {
            let html = '';
            app.jobCards.forEach(card => {
                const componentCount = new Set(app.assemblies.filter(a => a.jobCard === card.cardNo).map(a => a.componentId)).size;
                
                html += `<tr>
                    <td>${card.cardNo}</td>
                    <td>${card.date}</td>
                    <td>${card.assemblies.map(a => a.assemblyNo + '(' + a.qty + ')').join(', ')}</td>
                    <td>${componentCount} items</td>
                    <td><span class="badge badge-success">Created</span></td>
                    <td><button class="btn btn-small btn-secondary" onclick="deleteJobCard('${card.cardNo}')">Delete</button></td>
                </tr>`;
            });
            document.getElementById('jc-body').innerHTML = html || '<tr><td colspan="6" style="text-align: center;">No job cards yet</td></tr>';
        }

        function renderAssembly() {
            const assemblyMap = {};
            
            app.assemblies.forEach(a => {
                if (!assemblyMap[a.assemblyNo]) {
                    assemblyMap[a.assemblyNo] = [];
                }
                assemblyMap[a.assemblyNo].push(a);
            });

            let html = '';
            Object.entries(assemblyMap).forEach(([assemblyNo, records]) => {
                if (records.length === 0) return;
                
                const totalRequired = records[0].requiredQty;
                const totalAssembled = records[0].assembledQty;
                const pending = totalRequired - totalAssembled;
                const status = pending === 0 ? 'Completed' : totalAssembled === 0 ? 'Pending' : 'In Progress';
                const componentName = records[0].componentName;
                const jobCard = records[0].jobCard;
                
                html += `<tr>
                    <td>${assemblyNo}</td>
                    <td>${jobCard}</td>
                    <td>${componentName}</td>
                    <td>${totalRequired}</td>
                    <td><input type="number" value="${totalAssembled}" min="0" max="${totalRequired}" style="width: 60px;" onchange="updateAssembly(event, '${assemblyNo}')"></td>
                    <td>${pending}</td>
                    <td><span class="badge badge-${status === 'Completed' ? 'success' : status === 'Pending' ? 'error' : 'warning'}">${status}</span></td>
                    <td><button class="btn btn-small btn-secondary" onclick="deleteAssemblyBase('${assemblyNo}')">Delete</button></td>
                </tr>`;
            });
            document.getElementById('assembly-body').innerHTML = html || '<tr><td colspan="8" style="text-align: center;">No assemblies yet</td></tr>';
        }

        // ============================================================================
        // MODAL FUNCTIONS
        // ============================================================================
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddMaterialModal() {
            document.getElementById('mat-id').value = '';
            document.getElementById('mat-name').value = '';
            document.getElementById('mat-type').value = 'Cast Iron';
            document.getElementById('mat-uom').value = 'Pcs';
            document.getElementById('mat-opening-stock').value = '0';
            document.getElementById('mat-min-stock').value = '50';
            document.getElementById('mat-lead-time').value = '7';
            document.getElementById('mat-price').value = '0';
            document.getElementById('addMaterialModal').classList.add('active');
        }

        function showAddVendorModal() {
            document.getElementById('vendor-code').value = '';
            document.getElementById('vendor-name').value = '';
            document.getElementById('vendor-contact').value = '';
            document.getElementById('vendor-city').value = '';
            document.getElementById('vendor-state').value = '';
            document.getElementById('vendor-gst').value = '';
            document.getElementById('vendor-rating').value = '4';
            document.getElementById('addVendorModal').classList.add('active');
        }

        function showAddBOMModal() {
            document.getElementById('bom-assembly-no').value = '';
            document.getElementById('bom-component').value = '';
            document.getElementById('bom-qty').value = '';
            populateBOMComponent();
            document.getElementById('addBOMModal').classList.add('active');
        }

        function showAddFoundryOrderModal() {
            document.getElementById('fo-order-no').value = '';
            document.getElementById('fo-order-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('fo-supplier').value = '';
            document.getElementById('fo-component').value = '';
            document.getElementById('fo-qty-ordered').value = '';
            document.getElementById('fo-expected-due').value = '';
            document.getElementById('fo-remarks').value = '';
            populateFoundryOrderSelects();
            document.getElementById('addFoundryOrderModal').classList.add('active');
        }

        function showAddFoundryLotModal() {
            document.getElementById('fo-lot-order-no').value = '';
            document.getElementById('fo-lot-batch-id').value = '';
            document.getElementById('fo-lot-received-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('fo-lot-received-qty').value = '';
            document.getElementById('fo-lot-accepted-qty').value = '';
            document.getElementById('fo-lot-rejected-qty').value = '0';
            document.getElementById('fo-lot-inspection').value = 'Passed';
            populateFoundryLotOrders();
            document.getElementById('addFoundryLotModal').classList.add('active');
        }

        function showAddJobWorkModal() {
            document.getElementById('jw-order-no').value = '';
            document.getElementById('jw-order-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('jw-subcontractor').value = '';
            document.getElementById('jw-component').value = '';
            document.getElementById('jw-nature').value = 'Drilling';
            document.getElementById('jw-qty-sent').value = '';
            document.getElementById('jw-expected-due').value = '';
            populateJobWorkSelects();
            document.getElementById('addJobWorkModal').classList.add('active');
        }

        function showAddJobWorkLotModal() {
            document.getElementById('jw-lot-order-no').value = '';
            document.getElementById('jw-lot-lot-no').value = '';
            document.getElementById('jw-lot-batch-id').value = '';
            document.getElementById('jw-lot-received-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('jw-lot-received-qty').value = '';
            document.getElementById('jw-lot-accepted-qty').value = '';
            document.getElementById('jw-lot-rejected-qty').value = '0';
            populateJobWorkLotOrders();
            document.getElementById('addJobWorkLotModal').classList.add('active');
        }

        function showAddJobCardModal() {
            document.getElementById('jc-no').value = '';
            document.getElementById('jc-date').value = new Date().toISOString().split('T')[0];
            populateJobCardAssemblies();
            document.getElementById('addJobCardModal').classList.add('active');
        }

        function showAddUserModal() {
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-confirm-password').value = '';
            document.getElementById('addUserModal').classList.add('active');
        }

        // ============================================================================
        // SAVE FUNCTIONS
        // ============================================================================
        function saveMaterial(event) {
            event.preventDefault();
            const mat = {
                id: document.getElementById('mat-id').value,
                name: document.getElementById('mat-name').value,
                type: document.getElementById('mat-type').value,
                uom: document.getElementById('mat-uom').value,
                openingStock: parseInt(document.getElementById('mat-opening-stock').value) || 0,
                minStock: parseInt(document.getElementById('mat-min-stock').value) || 50,
                leadTime: parseInt(document.getElementById('mat-lead-time').value) || 7,
                price: parseFloat(document.getElementById('mat-price').value) || 0
            };

            const idx = app.materials.findIndex(m => m.id === mat.id);
            if (idx >= 0) {
                app.materials[idx] = mat;
            } else {
                app.materials.push(mat);
            }

            saveDataToStorage();
            closeModal('addMaterialModal');
            renderAllSections();
        }

        function saveVendor(event) {
            event.preventDefault();
            const vendor = {
                code: document.getElementById('vendor-code').value,
                name: document.getElementById('vendor-name').value,
                contact: document.getElementById('vendor-contact').value,
                city: document.getElementById('vendor-city').value,
                state: document.getElementById('vendor-state').value,
                gst: document.getElementById('vendor-gst').value,
                rating: parseInt(document.getElementById('vendor-rating').value)
            };

            const idx = app.vendors.findIndex(v => v.code === vendor.code);
            if (idx >= 0) {
                app.vendors[idx] = vendor;
            } else {
                app.vendors.push(vendor);
            }

            saveDataToStorage();
            closeModal('addVendorModal');
            renderAllSections();
        }

        function saveBOM(event) {
            event.preventDefault();
            const entry = {
                assemblyNo: document.getElementById('bom-assembly-no').value,
                componentId: document.getElementById('bom-component').value,
                requiredQty: parseInt(document.getElementById('bom-qty').value)
            };

            app.bom.push(entry);
            saveDataToStorage();
            closeModal('addBOMModal');
            renderAllSections();
        }

        function saveFoundryOrder(event) {
            event.preventDefault();
            const order = {
                orderNo: document.getElementById('fo-order-no').value,
                date: document.getElementById('fo-order-date').value,
                supplierCode: document.getElementById('fo-supplier').value.split('|')[0],
                supplierName: document.getElementById('fo-supplier').value.split('|')[1],
                componentId: document.getElementById('fo-component').value.split('|')[0],
                componentName: document.getElementById('fo-component').value.split('|')[1],
                qtyOrdered: parseInt(document.getElementById('fo-qty-ordered').value),
                expectedDue: document.getElementById('fo-expected-due').value,
                remarks: document.getElementById('fo-remarks').value
            };

            const idx = app.foundryOrders.findIndex(o => o.orderNo === order.orderNo);
            if (idx >= 0) {
                app.foundryOrders[idx] = order;
            } else {
                app.foundryOrders.push(order);
            }

            saveDataToStorage();
            closeModal('addFoundryOrderModal');
            renderAllSections();
        }

        function saveFoundryLot(event) {
            event.preventDefault();
            const lot = {
                id: 'FOL-' + Date.now(),
                orderNo: document.getElementById('fo-lot-order-no').value,
                lotNo: (app.foundryLots.filter(l => l.orderNo === document.getElementById('fo-lot-order-no').value).length + 1).toString(),
                batchId: document.getElementById('fo-lot-batch-id').value,
                receivedDate: document.getElementById('fo-lot-received-date').value,
                receivedQty: parseInt(document.getElementById('fo-lot-received-qty').value),
                acceptedQty: parseInt(document.getElementById('fo-lot-accepted-qty').value),
                rejectedQty: parseInt(document.getElementById('fo-lot-rejected-qty').value),
                inspectionStatus: document.getElementById('fo-lot-inspection').value
            };

            if (lot.acceptedQty + lot.rejectedQty > lot.receivedQty) {
                alert('‚ùå Accepted + Rejected qty cannot exceed Received qty!');
                return;
            }

            app.foundryLots.push(lot);
            saveDataToStorage();
            closeModal('addFoundryLotModal');
            renderAllSections();
        }

        function saveJobWork(event) {
            event.preventDefault();
            const qtySent = parseInt(document.getElementById('jw-qty-sent').value);
            const maxAvailable = getAvailableForJobWork(document.getElementById('jw-component').value.split('|')[0]);

            if (qtySent > maxAvailable) {
                alert(`‚ùå Cannot send ${qtySent} units. Only ${maxAvailable} units available from Foundry!`);
                return;
            }

            const order = {
                orderNo: document.getElementById('jw-order-no').value,
                date: document.getElementById('jw-order-date').value,
                subCode: document.getElementById('jw-subcontractor').value.split('|')[0],
                subName: document.getElementById('jw-subcontractor').value.split('|')[1],
                componentId: document.getElementById('jw-component').value.split('|')[0],
                componentName: document.getElementById('jw-component').value.split('|')[1],
                nature: document.getElementById('jw-nature').value,
                qtySent: qtySent,
                expectedDue: document.getElementById('jw-expected-due').value
            };

            const idx = app.jobWorkOrders.findIndex(o => o.orderNo === order.orderNo);
            if (idx >= 0) {
                app.jobWorkOrders[idx] = order;
            } else {
                app.jobWorkOrders.push(order);
            }

            saveDataToStorage();
            closeModal('addJobWorkModal');
            renderAllSections();
        }

        function saveJobWorkLot(event) {
            event.preventDefault();
            const lot = {
                id: 'JWL-' + Date.now(),
                refOrderNo: document.getElementById('jw-lot-order-no').value,
                lotNo: document.getElementById('jw-lot-lot-no').value,
                batchId: document.getElementById('jw-lot-batch-id').value,
                receivedDate: document.getElementById('jw-lot-received-date').value,
                receivedQty: parseInt(document.getElementById('jw-lot-received-qty').value),
                acceptedQty: parseInt(document.getElementById('jw-lot-accepted-qty').value),
                rejectedQty: parseInt(document.getElementById('jw-lot-rejected-qty').value)
            };

            if (lot.acceptedQty + lot.rejectedQty > lot.receivedQty) {
                alert('‚ùå Accepted + Rejected qty cannot exceed Received qty!');
                return;
            }

            app.jobWorkLots.push(lot);
            saveDataToStorage();
            closeModal('addJobWorkLotModal');
            renderAllSections();
        }

        function saveJobCard(event) {
            event.preventDefault();
            const cardNo = document.getElementById('jc-no').value;
            const date = document.getElementById('jc-date').value;
            
            const selectedAssemblies = [];
            document.querySelectorAll('#jc-assembly-selector .jc-checkbox:checked').forEach(checkbox => {
                const assemblyNo = checkbox.getAttribute('data-assembly');
                const qtyInput = document.querySelector(`input[data-assembly="${assemblyNo}"].jc-qty`);
                const qty = parseInt(qtyInput.value) || 0;
                if (qty > 0) {
                    selectedAssemblies.push({assemblyNo, qty});
                }
            });

            if (selectedAssemblies.length === 0) {
                alert('‚ùå Please select at least one assembly with quantity');
                return;
            }

            for (const selection of selectedAssemblies) {
                const bomEntries = app.bom.filter(b => b.assemblyNo === selection.assemblyNo);
                for (const bom of bomEntries) {
                    const needed = bom.requiredQty * selection.qty;
                    const available = getAvailableForAssembly(bom.componentId);
                    if (needed > available) {
                        alert(`‚ùå Insufficient stock for ${bom.componentId}. Needed: ${needed}, Available: ${available}`);
                        return;
                    }
                }
            }

            app.jobCards.push({cardNo, date, assemblies: selectedAssemblies});

            selectedAssemblies.forEach(selection => {
                const bomEntries = app.bom.filter(b => b.assemblyNo === selection.assemblyNo);
                for (let i = 1; i <= selection.qty; i++) {
                    bomEntries.forEach(bom => {
                        const comp = app.materials.find(m => m.id === bom.componentId);
                        app.assemblies.push({
                            assemblyNo: `${selection.assemblyNo}-${i}`,
                            jobCard: cardNo,
                            componentId: bom.componentId,
                            componentName: comp ? comp.name : 'Unknown',
                            requiredQty: bom.requiredQty,
                            assembledQty: 0
                        });
                    });
                }
            });

            saveDataToStorage();
            closeModal('addJobCardModal');
            renderAllSections();
            alert('‚úÖ Job Card created with ' + selectedAssemblies.reduce((sum, s) => sum + s.qty, 0) + ' assemblies!');
        }

        // ============================================================================
        // EDIT & DELETE FUNCTIONS
        // ============================================================================
        function editMaterial(id) {
            const mat = app.materials.find(m => m.id === id);
            if (mat) {
                document.getElementById('mat-id').value = mat.id;
                document.getElementById('mat-name').value = mat.name;
                document.getElementById('mat-type').value = mat.type;
                document.getElementById('mat-uom').value = mat.uom;
                document.getElementById('mat-opening-stock').value = mat.openingStock;
                document.getElementById('mat-min-stock').value = mat.minStock;
                document.getElementById('mat-lead-time').value = mat.leadTime;
                document.getElementById('mat-price').value = mat.price;
                document.getElementById('addMaterialModal').classList.add('active');
            }
        }

        function editVendor(code) {
            const vendor = app.vendors.find(v => v.code === code);
            if (vendor) {
                document.getElementById('vendor-code').value = vendor.code;
                document.getElementById('vendor-name').value = vendor.name;
                document.getElementById('vendor-contact').value = vendor.contact;
                document.getElementById('vendor-city').value = vendor.city;
                document.getElementById('vendor-state').value = vendor.state;
                document.getElementById('vendor-gst').value = vendor.gst;
                document.getElementById('vendor-rating').value = vendor.rating;
                document.getElementById('addVendorModal').classList.add('active');
            }
        }

        function editFoundryOrder(orderNo) {
            const order = app.foundryOrders.find(o => o.orderNo === orderNo);
            if (order) {
                document.getElementById('fo-order-no').value = order.orderNo;
                document.getElementById('fo-order-date').value = order.date;
                document.getElementById('fo-supplier').value = `${order.supplierCode}|${order.supplierName}`;
                document.getElementById('fo-component').value = `${order.componentId}|${order.componentName}`;
                document.getElementById('fo-qty-ordered').value = order.qtyOrdered;
                document.getElementById('fo-expected-due').value = order.expectedDue;
                document.getElementById('fo-remarks').value = order.remarks;
                document.getElementById('addFoundryOrderModal').classList.add('active');
            }
        }

        function editJobWork(orderNo) {
            const order = app.jobWorkOrders.find(o => o.orderNo === orderNo);
            if (order) {
                document.getElementById('jw-order-no').value = order.orderNo;
                document.getElementById('jw-order-date').value = order.date;
                document.getElementById('jw-subcontractor').value = `${order.subCode}|${order.subName}`;
                document.getElementById('jw-component').value = `${order.componentId}|${order.componentName}`;
                document.getElementById('jw-nature').value = order.nature;
                document.getElementById('jw-qty-sent').value = order.qtySent;
                document.getElementById('jw-expected-due').value = order.expectedDue;
                document.getElementById('addJobWorkModal').classList.add('active');
            }
        }

        function deleteBOM(idx) {
            if (confirm('Delete this BOM entry?')) {
                app.bom.splice(idx, 1);
                saveDataToStorage();
                renderAllSections();
            }
        }

        function deleteFoundryLot(idx) {
            if (confirm('Delete this foundry lot?')) {
                app.foundryLots.splice(idx, 1);
                saveDataToStorage();
                renderAllSections();
            }
        }

        function deleteJobWorkLot(idx) {
            if (confirm('Delete this job work lot?')) {
                app.jobWorkLots.splice(idx, 1);
                saveDataToStorage();
                renderAllSections();
            }
        }

        function deleteJobCard(cardNo) {
            if (confirm('Delete this job card and all its assemblies?')) {
                app.jobCards = app.jobCards.filter(c => c.cardNo !== cardNo);
                app.assemblies = app.assemblies.filter(a => a.jobCard !== cardNo);
                saveDataToStorage();
                renderAllSections();
            }
        }

        function deleteAssemblyBase(assemblyNo) {
            if (confirm(`Delete assembly ${assemblyNo} and all its components?`)) {
                app.assemblies = app.assemblies.filter(a => a.assemblyNo !== assemblyNo);
                saveDataToStorage();
                renderAllSections();
            }
        }

        // ============================================================================
        // UPDATE FUNCTIONS (INLINE EDITING)
        // ============================================================================
        function updateFoundryLot(idx, field, value) {
            app.foundryLots[idx][field] = field.includes('Qty') || field.includes('Date') || field === 'inspectionStatus' ? 
                (isNaN(value) ? value : parseInt(value)) : value;
            
            if (field === 'acceptedQty' || field === 'rejectedQty') {
                const lot = app.foundryLots[idx];
                if (lot.acceptedQty + lot.rejectedQty > lot.receivedQty) {
                    alert('‚ùå Accepted + Rejected cannot exceed Received qty!');
                    lot[field] = 0;
                }
            }

            saveDataToStorage();
            renderAllSections();
        }

        function updateJobWorkLot(idx, field, value) {
            app.jobWorkLots[idx][field] = field.includes('Qty') || field === 'lotNo' || field === 'batchId' || field === 'receivedDate' ? 
                (isNaN(value) ? value : parseInt(value)) : value;
            
            if (field === 'acceptedQty' || field === 'rejectedQty') {
                const lot = app.jobWorkLots[idx];
                if (lot.acceptedQty + lot.rejectedQty > lot.receivedQty) {
                    alert('‚ùå Accepted + Rejected cannot exceed Received qty!');
                    lot[field] = 0;
                }
            }

            saveDataToStorage();
            renderAllSections();
        }

        function updateAssembly(event, assemblyNo) {
            const newQty = parseInt(event.target.value) || 0;
            const assemblies = app.assemblies.filter(a => a.assemblyNo === assemblyNo);
            
            if (assemblies.length === 0) return;
            
            const reqQty = assemblies[0].requiredQty;
            
            if (newQty > reqQty) {
                alert(`‚ùå Cannot assemble more than required (${reqQty})`);
                event.target.value = assemblies[0].assembledQty;
                return;
            }
            
            assemblies.forEach(a => {
                a.assembledQty = newQty;
            });
            
            saveDataToStorage();
            renderAllSections();
        }

        // ============================================================================
        // POPULATE SELECTS
        // ============================================================================
        function populateBOMComponent() {
            let html = '<option value="">Select Component</option>';
            app.materials.forEach(m => {
                html += `<option value="${m.id}">${m.name} (${m.id})</option>`;
            });
            document.getElementById('bom-component').innerHTML = html;
        }

        function populateFoundryOrderSelects() {
            let supplierHtml = '<option value="">Select Supplier</option>';
            app.vendors.forEach(v => {
                supplierHtml += `<option value="${v.code}|${v.name}">${v.name}</option>`;
            });
            document.getElementById('fo-supplier').innerHTML = supplierHtml;

            let componentHtml = '<option value="">Select Component</option>';
            app.materials.forEach(m => {
                componentHtml += `<option value="${m.id}|${m.name}">${m.name}</option>`;
            });
            document.getElementById('fo-component').innerHTML = componentHtml;
        }

        function populateFoundryLotOrders() {
            let html = '<option value="">Select Order No</option>';
            app.foundryOrders.forEach(o => {
                html += `<option value="${o.orderNo}">${o.orderNo} - ${o.componentName}</option>`;
            });
            document.getElementById('fo-lot-order-no').innerHTML = html;
        }

        function populateJobWorkSelects() {
            let vendorHtml = '<option value="">Select Subcontractor</option>';
            app.vendors.forEach(v => {
                vendorHtml += `<option value="${v.code}|${v.name}">${v.name}</option>`;
            });
            document.getElementById('jw-subcontractor').innerHTML = vendorHtml;

            let componentHtml = '<option value="">Select Component</option>';
            app.materials.forEach(m => {
                componentHtml += `<option value="${m.id}|${m.name}">${m.name}</option>`;
            });
            document.getElementById('jw-component').innerHTML = componentHtml;
        }

        function populateJobWorkLotOrders() {
            let html = '<option value="">Select Order No</option>';
            app.jobWorkOrders.forEach(o => {
                html += `<option value="${o.orderNo}">${o.orderNo} - ${o.componentName}</option>`;
            });
            document.getElementById('jw-lot-order-no').innerHTML = html;
        }

        function populateJobCardAssemblies() {
            const uniqueAssemblies = [...new Set(app.bom.map(b => b.assemblyNo))];
            let html = '';
            
            if (uniqueAssemblies.length === 0) {
                html = '<p style="color: var(--color-warning);">‚ùå No assemblies defined in BOM. Please create BOM entries first.</p>';
            } else {
                uniqueAssemblies.forEach(assemblyNo => {
                    html += `<div style="padding: 12px; background: rgba(32,135,145,0.05); margin-bottom: 12px; border-radius: 6px;">
                        <label style="display: flex; align-items: center; gap: 12px; margin: 0;">
                            <input type="checkbox" class="jc-checkbox" value="${assemblyNo}" data-assembly="${assemblyNo}">
                            <strong>${assemblyNo}</strong>
                        </label>
                        <div style="margin-top: 8px; margin-left: 30px;">
                            <label>Number of units:</label>
                            <input type="number" min="1" value="1" data-assembly="${assemblyNo}" class="jc-qty" style="width: 80px;">
                        </div>
                    </div>`;
                });
            }
            
            document.getElementById('jc-assembly-selector').innerHTML = html;
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        function switchTab(event, tabName) {
            event.preventDefault();
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function filterTable(searchId, tableBodyId) {
            const searchText = document.getElementById(searchId).value.toLowerCase();
            const rows = document.getElementById(tableBodyId).getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        }

        function checkStockLevels() {
            const lowStock = [];
            app.materials.forEach(mat => {
                const closing = calculateClosingStock(mat.id);
                if (closing < mat.minStock) {
                    lowStock.push(`${mat.id} - ${mat.name}: ${closing}/${mat.minStock}`);
                }
            });

            if (lowStock.length > 0) {
                document.getElementById('alertMessage').textContent = lowStock.join(' | ');
                document.getElementById('stockAlert').style.display = 'flex';
            } else {
                document.getElementById('stockAlert').style.display = 'none';
            }
        }

        function dismissStockAlert() {
            document.getElementById('stockAlert').style.display = 'none';
        }

        // ============================================================================
        // EXPORT & LOCAL BACKUP FUNCTIONS
        // ============================================================================
        function exportMaterialMaster() { exportToCSV(app.materials, 'Material_Master'); }
        function exportVendorMaster() { exportToCSV(app.vendors, 'Vendor_Master'); }
        function exportBOM() { exportToCSV(app.bom, 'BOM'); }
        function exportFoundryOrder() { exportToCSV(app.foundryOrders, 'Foundry_Orders'); }
        function exportFoundryLots() { exportToCSV(app.foundryLots, 'Foundry_Lots'); }
        function exportJobWork() { exportToCSV(app.jobWorkOrders, 'Job_Work_Orders'); }
        function exportJobWorkLots() { exportToCSV(app.jobWorkLots, 'Job_Work_Lots'); }
        function exportJobCard() { exportToCSV(app.jobCards, 'Job_Cards'); }
        function exportAssembly() { exportToCSV(app.assemblies, 'Assembly'); }

        function exportAllData() {
            const allData = {
                'Materials': app.materials,
                'Vendors': app.vendors,
                'BOM': app.bom,
                'Foundry_Orders': app.foundryOrders,
                'Foundry_Lots': app.foundryLots,
                'Job_Work_Orders': app.jobWorkOrders,
                'Job_Work_Lots': app.jobWorkLots,
                'Job_Cards': app.jobCards,
                'Assembly': app.assemblies
            };

            const csv = Object.entries(allData).map(([sheet, data]) => {
                return `\n\n=== ${sheet} ===\n` + arrayToCSV(data);
            }).join('');

            downloadFile(csv, 'Manufacturing_System_v3_Complete.csv');
        }

        function exportToCSV(data, fileName) {
            const csv = arrayToCSV(data);
            downloadFile(csv, `${fileName}.csv`);
        }

        function arrayToCSV(arr) {
            if (arr.length === 0) return '';
            const headers = Object.keys(arr[0]);
            const csv = [headers.join(',')];
            arr.forEach(obj => {
                const row = headers.map(h => {
                    const val = obj[h];
                    return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                });
                csv.push(row.join(','));
            });
            return csv.join('\n');
        }

        function downloadFile(content, fileName) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', fileName);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        Object.assign(app, imported);
                        saveDataToStorage();
                        renderAllSections();
                        alert('‚úÖ Data imported successfully!');
                    } catch (error) {
                        alert('‚ùå Error importing file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL data? This cannot be undone!')) {
                app.materials = [];
                app.vendors = [];
                app.bom = [];
                app.foundryOrders = [];
                app.foundryLots = [];
                app.jobWorkOrders = [];
                app.jobWorkLots = [];
                app.jobCards = [];
                app.assemblies = [];
                saveDataToStorage();
                renderAllSections();
                alert('‚úÖ All data cleared!');
            }
        }

        function backupDataNow() {
            const backup = {
                timestamp: new Date().toISOString(),
                data: app
            };
            localStorage.setItem('manufacturingBackup', JSON.stringify(backup));
            updateBackupInfo();
            alert('‚úÖ Backup created successfully!');
        }

        function restoreDataNow() {
            const backup = localStorage.getItem('manufacturingBackup');
            if (!backup) {
                alert('‚ùå No backup found!');
                return;
            }
            
            if (confirm('‚ö†Ô∏è This will replace all current data with the backup. Continue?')) {
                const data = JSON.parse(backup);
                Object.assign(app, data.data);
                saveDataToStorage();
                renderAllSections();
                alert('‚úÖ Data restored successfully!');
            }
        }

        function updateBackupInfo() {
            const backup = localStorage.getItem('manufacturingBackup');
            if (backup) {
                const data = JSON.parse(backup);
                const date = new Date(data.timestamp);
                document.getElementById('last-backup-time').textContent = date.toLocaleString();
                document.getElementById('backup-size').textContent = (backup.length / 1024).toFixed(2) + ' KB';
            }
        }

        function backupData() {
            backupDataNow();
        }

        function restoreData() {
            restoreDataNow();
        }

        // ============================================================================
        // USER MANAGEMENT
        // ============================================================================
        function renderUserManagement() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            let html = '';
            
            Object.entries(users).forEach(([username]) => {
                const isCurrentUser = username === currentUser;
                html += `<tr>
                    <td>${username}${isCurrentUser ? ' <span class="badge badge-success">Current</span>' : ''}</td>
                    <td>System</td>
                    <td><span class="badge badge-success">Active</span></td>
                    <td>
                        ${!isCurrentUser ? `<button class="btn btn-small btn-secondary" onclick="deleteUserAccount('${username}')">Delete</button>` : '<span style="color: #999;">-</span>'}
                    </td>
                </tr>`;
            });

            document.getElementById('user-list-body').innerHTML = html || '<tr><td colspan="4" style="text-align: center;">No users yet</td></tr>';
        }

        function saveNewUser(event) {
            event.preventDefault();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('new-confirm-password').value;

            if (!username || !password) {
                alert('‚ùå Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                alert('‚ùå Passwords do not match');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username]) {
                alert('‚ùå Username already exists');
                return;
            }

            users[username] = password;
            localStorage.setItem('users', JSON.stringify(users));
            
            closeModal('addUserModal');
            renderUserManagement();
            alert('‚úÖ User ' + username + ' added successfully!');
        }

        function deleteUserAccount(username) {
            if (confirm(`‚ö†Ô∏è Delete user "${username}"? This cannot be undone.`)) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                delete users[username];
                localStorage.setItem('users', JSON.stringify(users));
                renderUserManagement();
                alert('‚úÖ User deleted successfully!');
            }
        }

        // ============================================================================
        // STORAGE
        // ============================================================================
        function saveDataToStorage() {
            localStorage.setItem('manufacturingDataV3', JSON.stringify(app));
        }

        function loadDataFromStorage() {
            const stored = localStorage.getItem('manufacturingDataV3');
            if (stored) {
                Object.assign(app, JSON.parse(stored));
            }
        }

        // ============================================================================
        // GOOGLE DRIVE BACKUP / RESTORE
        // ============================================================================
        const GOOGLE_CLIENT_ID = '148182865660-4mt8nfgp64kmb1qufsfs8oerf73gsgpm.apps.googleusercontent.com'; // <-- replace with your real client ID
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const BACKUP_FOLDER_NAME = 'Manufacturing_Backups';

        let googleAccessToken = null;
        let googleFolderID = null;
        let googleUserEmail = null;

        function initGoogleSignIn() {
            if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.startsWith('YOUR_CLIENT_ID_HERE')) {
                alert('‚ùå Please configure GOOGLE_CLIENT_ID in the HTML file.');
                return;
            }

            google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: (tokenResponse) => {
                    googleAccessToken = tokenResponse.access_token;
                    localStorage.setItem('googleToken', googleAccessToken);
                    gapi.load('client', () => {
                        gapi.client.setToken({access_token: googleAccessToken});
                        gapi.client.load('drive', 'v3', () => {
                            getGoogleUserInfo().then(() => {
                                ensureGoogleFolder().then(() => {
                                    updateGoogleDriveUI();
                                });
                            });
                        });
                    });
                }
            }).requestAccessToken();
        }

        async function getGoogleUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        Authorization: 'Bearer ' + googleAccessToken
                    }
                });
                if (!response.ok) throw new Error('User info failed');
                const data = await response.json();
                googleUserEmail = data.email || 'Unknown';
            } catch (e) {
                console.error(e);
                googleUserEmail = 'Unknown';
            }
        }

        async function ensureGoogleFolder() {
            if (!googleAccessToken) return;
            if (googleFolderID) return;

            const query = `name='${BACKUP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
            const res = await gapi.client.drive.files.list({
                q: query,
                fields: 'files(id, name)'
            });

            if (res.result.files && res.result.files.length > 0) {
                googleFolderID = res.result.files[0].id;
                return;
            }

            const folderMetadata = {
                name: BACKUP_FOLDER_NAME,
                mimeType: 'application/vnd.google-apps.folder'
            };

            const createRes = await gapi.client.drive.files.create({
                resource: folderMetadata,
                fields: 'id'
            });

            googleFolderID = createRes.result.id;
        }

        function updateGoogleDriveUI() {
            const section = document.getElementById('gdrive-section');
            const signinDiv = document.getElementById('gdrive-signin');
            const statusDiv = document.getElementById('gdriveStatus');
            const statusText = document.getElementById('gdriveStatusText');

            if (googleAccessToken) {
                section.style.display = 'block';
                signinDiv.style.display = 'none';
                statusDiv.style.display = 'block';
                statusText.textContent = `‚úÖ Connected as ${googleUserEmail || 'Google User'}`;
            } else {
                section.style.display = 'none';
                signinDiv.style.display = 'block';
                statusDiv.style.display = 'none';
            }
        }

        async function backupToGoogleDrive() {
            if (!googleAccessToken) {
                alert('‚ÑπÔ∏è Please sign in with Google Drive first.');
                return;
            }

            try {
                const backupPayload = {
                    timestamp: new Date().toISOString(),
                    user: currentUser,
                    data: app
                };

                const fileName = `ManufacturingBackup_${currentUser || 'User'}_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                const boundary = '-------314159265358979323846';
                const delimiter = '\r\n--' + boundary + '\r\n';
                const closeDelim = '\r\n--' + boundary + '--';

                const metadata = {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: googleFolderID ? [googleFolderID] : []
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(backupPayload) +
                    closeDelim;

                const request = gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: {uploadType: 'multipart'},
                    headers: {
                        'Content-Type': 'multipart/related; boundary=' + boundary
                    },
                    body: multipartRequestBody
                });

                await request;
                alert('‚úÖ Backup uploaded to Google Drive!');
                listGoogleDriveBackups();
            } catch (e) {
                console.error(e);
                alert('‚ùå Google Drive backup failed.');
            }
        }

        async function listGoogleDriveBackups() {
            if (!googleAccessToken) {
                alert('‚ÑπÔ∏è Please sign in with Google Drive first.');
                return;
            }

            try {
                const folderId = googleFolderID;
                let query = `mimeType='application/json' and trashed=false`;
                if (folderId) {
                    query += ` and '${folderId}' in parents`;
                } else {
                    query += ` and name contains 'ManufacturingBackup_'`;
                }

                const res = await gapi.client.drive.files.list({
                    q: query,
                    orderBy: 'createdTime desc',
                    fields: 'files(id, name, size, createdTime)'
                });

                const files = res.result.files || [];
                const tbody = document.getElementById('gdrive-backup-history');
                document.getElementById('gdriveHistoryCard').style.display = 'block';
                document.getElementById('gdrive-backup-count').textContent = files.length;

                if (files.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No backups found.</td></tr>';
                    return;
                }

                let html = '';
                files.forEach(file => {
                    const dt = new Date(file.createdTime);
                    const sizeKB = file.size ? (file.size / 1024).toFixed(2) + ' KB' : 'Unknown';
                    html += `<tr>
                        <td>${file.name}</td>
                        <td>${dt.toLocaleString()}</td>
                        <td>${sizeKB}</td>
                        <td><span class="badge badge-success">Available</span></td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="restoreFromGoogleDrive('${file.id}', '${file.name.replace(/'/g, "\\'")}')">Restore</button>
                        </td>
                    </tr>`;
                });

                tbody.innerHTML = html;
            } catch (e) {
                console.error(e);
                alert('‚ùå Unable to list Google Drive backups.');
            }
        }

        async function restoreFromGoogleDrive(fileId, fileName) {
            if (!googleAccessToken) {
                alert('‚ÑπÔ∏è Please sign in with Google Drive first.');
                return;
            }

            try {
                let targetFileId = fileId;

                if (!targetFileId) {
                    const folderId = googleFolderID;
                    let query = `mimeType='application/json' and trashed=false`;
                    if (folderId) {
                        query += ` and '${folderId}' in parents`;
                    } else {
                        query += ` and name contains 'ManufacturingBackup_'`;
                    }

                    const res = await gapi.client.drive.files.list({
                        q: query,
                        orderBy: 'createdTime desc',
                        pageSize: 1,
                        fields: 'files(id, name, createdTime)'
                    });

                    const files = res.result.files || [];
                    if (files.length === 0) {
                        alert('‚ùå No backups found in Google Drive.');
                        return;
                    }
                    targetFileId = files[0].id;
                    fileName = files[0].name;
                }

                if (!confirm(`‚ö†Ô∏è This will overwrite current data with backup "${fileName}". Continue?`)) {
                    return;
                }

                const resp = await gapi.client.drive.files.get({
                    fileId: targetFileId,
                    alt: 'media'
                });

                const backupContent = resp.result;
                if (!backupContent || !backupContent.data) {
                    alert('‚ùå Backup format invalid.');
                    return;
                }

                Object.assign(app, backupContent.data);
                saveDataToStorage();
                renderAllSections();
                alert('‚úÖ Data restored from Google Drive backup!');
            } catch (e) {
                console.error(e);
                alert('‚ùå Restore from Google Drive failed.');
            }
        }

        function googleLogout() {
            googleAccessToken = null;
            googleFolderID = null;
            googleUserEmail = null;
            localStorage.removeItem('googleToken');
            gapi.client.setToken(null);
            updateGoogleDriveUI();
            alert('üîå Disconnected from Google Drive.');
        }

        function checkGoogleSignIn() {
            const savedGoogleToken = localStorage.getItem('googleToken');
            if (savedGoogleToken) {
                googleAccessToken = savedGoogleToken;
                gapi.load('client', () => {
                    gapi.client.setToken({access_token: googleAccessToken});
                    gapi.client.load('drive', 'v3', () => {
                        getGoogleUserInfo().then(() => {
                            ensureGoogleFolder().then(() => {
                                updateGoogleDriveUI();
                            });
                        });
                    });
                });
            } else {
                updateGoogleDriveUI();
            }
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showApp();
            } else {
                initAuth();
            }
            setTimeout(updateBackupInfo, 1000);
            setTimeout(checkGoogleSignIn, 1000);
        });
    </script>
</body>
</html>
